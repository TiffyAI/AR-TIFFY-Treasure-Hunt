<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script>
      AFRAME.registerComponent('treasure-hunt', {
        init: function () {
          this.arrowContainer = document.querySelector('#arrow-container');
          this.arrow = document.querySelector('#arrow-text');
          this.message = document.querySelector('#message');
          this.sound = document.querySelector('#claim-sound');
          this.camera = document.querySelector('[gps-new-camera]');
          this.spawnCoin();

          // Blink arrow
          setInterval(() => {
            const visible = this.arrow.getAttribute('visible');
            this.arrow.setAttribute('visible', !visible);
          }, 500);
        },
        tick: function () {
          if (!this.coin) return;

          const coinPos = this.coin.object3D.position.clone();
          const camPos = this.camera.object3D.position.clone();

          // Distance check
          const distance = camPos.distanceTo(coinPos);
          if (distance < 1) {
            this.arrow.setAttribute('color', 'lime');
            this.collectTreasure();
          } else {
            this.arrow.setAttribute('color', '#00BFFF');
          }
        },
        spawnCoin: function () {
          // Remove old coin if exists
          if (this.coin && this.coin.parentNode) {
            this.coin.parentNode.removeChild(this.coin);
          }

          // Create new coin entity
          const coin = document.createElement('a-entity');
          coin.setAttribute('id', 'coin');
          coin.setAttribute('gltf-model', 'https://raw.githubusercontent.com/a-h/a-frame-3d-model/main/coin/scene.gltf');
          coin.setAttribute('scale', '0.01 0.01 0.01');
          coin.setAttribute('rotation', '0 90 0');

          const randLat = 34.052235 + (Math.random() - 0.5) * 0.0001;
          const randLon = -118.243683 + (Math.random() - 0.5) * 0.0001;
          coin.setAttribute('gps-entity-place', `latitude: ${randLat}; longitude: ${randLon};`);

          // Add click listener
          coin.addEventListener('click', () => this.collectTreasure());

          document.querySelector('a-scene').appendChild(coin);
          this.coin = coin;
        },
        collectTreasure: function () {
          if (!this.coin) return;
          this.sound.components.sound.playSound();
          this.message.setAttribute('visible', true);

          // Hide message after 2s and spawn next coin
          setTimeout(() => {
            this.message.setAttribute('visible', false);
            this.spawnCoin();
          }, 2000);

          this.coin.parentNode.removeChild(this.coin);
          this.coin = null;
        }
      });
    </script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    <a-scene
      vr-mode-ui="enabled: false"
      arjs='sourceType: webcam; debugUIEnabled: false;'
      treasure-hunt>
      
      <a-camera gps-new-camera></a-camera>

      <a-entity id="arrow-container" position="0 0 -5" look-at="#coin">
          <a-text
            id="arrow-text"
            value="⬆️"
            color="#00BFFF"
            align="center"
            scale="0.5 0.5 0.5"
            position="0 0 0">
          </a-text>
      </a-entity>

      <a-text 
        id="message" 
        value="✅ Treasure Found!" 
        color="lime" 
        align="center" 
        position="0 0 -2"
        scale="1 1 1"
        visible="false"></a-text>

      <a-entity id="claim-sound" sound="src: url(claim.wav); autoplay: false;"></a-entity>

    </a-scene>
  </body>
</html>
